#ifndef _JoyTerrainMaterialPS_H_
#define _JoyTerrainMaterialPS_H_

// Define In PS
#define __PS__

#include "JoyTerrainMaterial.inc"
#include "JoyTerrainNormalLayer.inc"

FragInput fmt_input( VS_OUT IN )
{
	FragInput FI = (FragInput)0;
	FI.baseTC			= IN.uvBottom;
#if g_MiddleLayerEnable == 1 || g_UpperLayerEnable == 1
	FI.extTC1			= IN.uvMiddleUpper;
#endif
#if g_BlendLayerEnable == 1 || g_ColorMapEnable == 1
	FI.extTC2			= IN.uvBlendLightColor;
#endif
#if g_DetailLayerEnable == 1 || g_NormalLayerEnable == 1
	FI.extTC3			= IN.uvDetailNormal;
#endif
	FI.vNormal		= float4( IN.normal.xyz, 0 );
#if g_NormalLayerEnable == 1
	FI.vTangent		= IN.tangent.xyz;
	FI.vBinormal	= IN.biNormal.xyz;
#endif
	FI.vView			= float4( normalize( IN.v.xyz ), IN.v.w );
	// FI.fog				= IN.fog;
	FI.position		= IN.pw;
	
	return FI;
}

static const float3 cLuminanceCoefficients = float3(0.2126, 0.7152, 0.0722);

PS_OUT fmt_output( FragParams params )
{
	PS_OUT OUT = (PS_OUT)0;
	OUT.color1 = float4( HDROutput(params).rgb, params.FI.position.w );
#if g_IsReleaseMode == 0
	if(ComplexityParams.x > 0)
	{
		OUT.color1.rgb = params.cComplexity.rgb;
	}
#endif
	OUT.color2 = float4( 1,0,0,0 );
	return OUT;
}

PS_OUT main( VS_OUT IN )
{
	FragParams params = (FragParams)0;
	params.FI = fmt_input( IN );
	
	/// 设置渲染参数
	fmt_rop( params );
	
	/// 底层
	Calc_Terrain_BottomLayer( params );

	/// 中层
	Calc_Terrain_MiddleLayer( params );
	
	/// 上层
	Calc_Terrain_UpperLayer( params );

	/// Color Map
	Calc_Color_Blend( params );
	
	Normal_Layer( params );

	/// lighting
	Calc_Light_In_Ps_FL( params );
	
	/// Beast
	Calc_BeastMap_Blend( params );

	/// fog
	// Calc_Fog_Color( params );
	Calc_Complexity_Color( params );

	return fmt_output( params );
}

#endif